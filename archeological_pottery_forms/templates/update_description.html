{% extends "base.html" %}
{% load static %}

{% block content %}

{% if user.is_authenticated %}
<form action="" method="post">
    {% csrf_token %}
    <div class="container">
        <br>
        <div class="row align-items-start">
            <div class="col">
                <div class="card">
                    <div class="card-body">
                        <p>registracijos numeris: {{find.find_registration_nr}}, {{find_nr}} iš {{finds_amount}} radinių</p>
                        <label for="arc_length">lanko ilgis:</label>
                        <input type="number" id="arc_length" name="arc_length" required="required"><br>
                        <label for="color">spalva:</label>
                        <input type="text" id="color" name="color"><br>
                        <label for="note">pastaba:</label>
                        <input type="text" id="note" name="note"><br>

                        <label for="neck_type">kaklelio tipas:</label>
                        <input list="neck_types" name="neck_type" id="neck_type">
                        <datalist id="neck_types">
                            <option value="tiesus">
                            <option value="lenktas į vidų">
                            <option value="lenktas į išorę">
                        </datalist>

                        <label for="neck_shoulders_union_type">kaklelio ir petelių jungties tipas:</label>
                        <input list="neck_shoulders_union_types" name="neck_shoulders_union_type"
                               id="neck_shoulders_union_type">
                        <datalist id="neck_shoulders_union_types">
                            <option value="neryški">
                            <option value="apvali">
                            <option value="užapvalintas lūžis">
                            <option value="lūžis su įspauda">
                        </datalist>

                        <label for="shoulders_type">petelių tipas:</label>
                        <input list="shoulders_types" name="shoulders_type" id="shoulders_type">
                        <datalist id="shoulders_types">
                            <option value="nežymiai išlenkta">
                            <option value="apvaliai išlenkta">
                            <option value="išlenkta su užapvalintu lūžiu">
                        </datalist>

                        <label for="neck_type">petelių ir kūno jungties tipas:</label>
                        <input list="shoulders_body_union_types" name="shoulders_body_union_type"
                               id="shoulders_body_union_type">
                        <datalist id="shoulders_body_union_types">
                            <option value="be lūžio">
                            <option value="užapvalintas lūžis">
                            <option value="ryškus lūžis">
                        </datalist>

                        <button type="submit" class="btn btn-primary register-button" id="change" name="change">
                            Įrašyti pakeitimus
                        </button>
                        <button type="submit" class="btn btn-primary register-button" id="change_new" name="change_new">
                            Įrašyti ir tvarkyti kitą
                        </button>
                    </div>


                </div>
            </div>


            <div class="col">
                <canvas id="myCanvas" width="500" height="500" class="border"></canvas>
                <div class="card-body">
                    <button type="submit" class="btn btn-primary register-button" id="previous" name="previous">
                        < Ankstesnis
                    </button>
                    <button type="submit" class="btn btn-primary register-button" id="next" name="next">
                        Kitas >
                    </button>
                    <button type="submit" class="btn btn-primary register-button" id="new" name="new">
                        Naujas radinys
                    </button>

                </div>
            </div>

            <div class="col">
                <div class="card-body">
                    <p id="y" value="">pasirinkite tašką profilio brėžinyje</p>
                    <button type="submit" class="btn btn-info" id="lip_base" name="lip_base">lupos apačia</button>
                    <br>
                    <button type="submit" class="btn btn-info" id="neck_base" name="neck_base">kaklo apačia</button>
                    <br>
                    <button type="submit" class="btn btn-info" id="shoulders_base" name="shoulders_base">petelių
                        apačia
                    </button>
                    <br>
                    <button type="submit" class="btn btn-info" id="bottom" name="bottom">dugnas</button>
                    <br>
                    <button type="submit" class="btn btn-warning" id="clear" name="clear">pašalinti linijas</button>
                    <br>
                </div>
                {% if lip_shape %}
                <p>lupos forma:</p>
                <img src="{{lip_shape.lip_form.url}}" alt="this find lip form">
                {% else %}
                <p>nėra duomenų apie lupos formą</p>
                {% endif %}

                {% if ornament_shape %}
                <img src="{{ornament_shape.ornament_form.url}}" alt="this find ornament form">
                {% else %}
                <p>nėra duomenų apie ornamentą</p>
                {% endif %}


            </div>
        </div>
    </div>
</form>

<script>
    var canvas = document.getElementById("myCanvas");
    var ctx = canvas.getContext("2d");
    ctx.scale(0.5, 0.5);

    function drawProfile() {
        {% if find.lip_base_y %}
            ctx.beginPath();
            ctx.moveTo(0, {{find.lip_base_y}} );
            ctx.lineTo(canvas.width*2, {{find.lip_base_y}} );
            ctx.lineWidth = 3;
            ctx.strokeStyle = '#ff0000'
            ctx.stroke();
        {% endif %}

        {% if find.neck_base_y %}
            ctx.beginPath();
            ctx.moveTo(0, {{find.neck_base_y}} );
            ctx.lineTo(canvas.width*2, {{find.neck_base_y}} );
            ctx.lineWidth = 3;
            ctx.strokeStyle = '#ffb600'
            ctx.stroke();
        {% endif %}

        {% if find.shoulders_base_y %}
            ctx.beginPath();
            ctx.moveTo(0, {{find.shoulders_base_y}} );
            ctx.lineTo(canvas.width*2, {{find.shoulders_base_y}} );
            ctx.lineWidth = 3;
            ctx.strokeStyle = '#8ae400'
            ctx.stroke();
        {% endif %}

        {% if find.bottom_y %}
            ctx.beginPath();
            ctx.moveTo(0, {{find.bottom_y}} );
            ctx.lineTo(canvas.width*2, {{find.bottom_y}} );
            ctx.lineWidth = 3;
            ctx.strokeStyle = '#005cfe'
            ctx.stroke();
        {% endif %}

        {% if contour %}
            {% for pixel in contour %}
                ctx.fillRect({{pixel.x_canvas_middle}}, {{pixel.y}},1,1);
            {% endfor %}
        {% endif %}
    };

    drawProfile()
</script>


<script>
    {% if find.arc_length %}
    document.getElementById("arc_length").value = {{find.arc_length}};
    {% endif %}

    {% if find.color %}
    document.getElementById("color").value = "{{find.color}}";
    {% endif %}

    {% if find.note %}
    document.getElementById("note").value = "{{find.note}}";
    {% endif %}

    {% if find.neck_type %}
    document.getElementById("neck_type").value = "{{find.neck_type}}";
    {% endif %}

    {% if find.shoulders_type %}
    document.getElementById("shoulders_type").value = "{{find.shoulders_type}}";
    {% endif %}

    {% if find.neck_shoulders_union %}
    document.getElementById("neck_shoulders_union_type").value = "{{find.neck_shoulders_union}}";
    {% endif %}

    {% if find.shoulders_body_union %}
    document.getElementById("shoulders_body_union_type").value = "{{find.shoulders_body_union}}";
    {% endif %}
</script>

<script>
    function getMousePosition(canvas, event) {
        let rect = canvas.getBoundingClientRect();
        let x = event.clientX - rect.left;
        let y = event.clientY - rect.top;
        console.log("Coordinate x: " + x,
                    "Coordinate y: " + y);
        document.getElementById("y").innerHTML = "pasirinktas taškas: " + y*2;
        document.getElementById("y").value = y*2;
        document.getElementById("lip_base").value = y*2;
        document.getElementById("neck_base").value = y*2;
        document.getElementById("shoulders_base").value = y*2;
        document.getElementById("bottom").value = y*2;
    };

    let canvasElem = document.querySelector("canvas");

    canvasElem.addEventListener("mousedown", function(e)
    {
        getMousePosition(canvasElem, e);

        ctx.clearRect(0, 0, canvas.width*2, canvas.height*2);
        drawProfile()

        let y_line = document.getElementById("y").value;
        ctx.beginPath();
        ctx.moveTo(0, y_line);
        ctx.lineTo(canvas.width*2, y_line);
        ctx.lineWidth = 1;
        ctx.strokeStyle = '#b2b2b2'
        ctx.stroke();
    });
</script>

{% endif %}

{% endblock %}